{% extends "common/layout.html" %}
{% block head %}
<meta name="description" content="CKhang">
<link href="{{ url_for('static', filename='css/blog.css') }}" rel="stylesheet" type="text/css">
<meta name="keywords" content="HTML,CSS,Angular,JavaScript,Typescript,Reddit,API,Binding,Input,Reactive Forms">
<link href="{{ url_for('static', filename='lib/highlight/vs2015.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block content %}
<div class="common-container">
    <div class="post-title">
        <h1>Simple Reddit client using Angular (3)</h1>
    </div>
    <div class="post-meta">
        <h3>2020 January 25th</h3>
    </div>
    <div class="post-content">
        <p><a href="/post/2020/simple-reddit-client-web-by-angular-2/">Last post</a>, we restructured the app and added subreddit browsing. In this post, we are going to style the app a bit then implement thread browsing feature.</p>

        <h3>Threads list styling</h3>
        <p>First we will add some style to <i>thread-list</i> component.</p>

        <i>src/app/components/thread-list/thread-list.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;list-thread&#x22;&#x3E;
    &#x3C;div class=&#x22;thread&#x22; *ngFor=&#x22;let thread of threads&#x22;&#x3E;
        &#x3C;div class=&#x22;title&#x22;&#x3E;&#x3C;a href=&#x22;{{ thread.permalink }}&#x22;&#x3E;{{ thread.linkFlairText }} {{ thread.title }}&#x3C;/a&#x3E;&#x3C;/div&#x3E;
        &#x3C;div class=&#x22;info-1&#x22;&#x3E;&#x3C;span class=&#x22;points&#x22;&#x3E;{{ thread.score }}&#x3C;/span&#x3E; pts - &#x3C;span class=&#x22;comments&#x22;&#x3E;{{ thread.num_comments }}&#x3C;/span&#x3E; comments&#x3C;/div&#x3E;
        &#x3C;div class=&#x22;info-2&#x22;&#x3E;{{ thread.createdTime| date:&#x27;fullDate&#x27; }} by &#x3C;span class=&#x22;user&#x22;&#x3E;{{ thread.author }}&#x3C;/span&#x3E;&#x3C;/div&#x3E;
    &#x3C;/div&#x3E;
&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}

        <i>src/app/components/thread-list/thread-list.component.scss</i>
        <pre><code class="css">
.list-thread {
    display: flex;
    flex-direction: column;
}

.thread {
    margin-bottom: 10px;
}

.thread .title {
    color: #353535;
}

.thread .points {
    color: #E64569;
}

.thread .user {
    color: #3d963b;
}

.thread .comments {
    color: #439ECF;
}
        </code></pre>

        <p>We update <i>thread</i> model to display more data. <i>created</i> time from json data is in second, so we need to multiply by 1000 to get value in millisecond.</p>
        <i>src/app/models/thread.ts</i>
        <pre><code class="typescript">
export class Thread {
    id: string;
    title: string;
    author: string;
    score: number;
    permalink: string;
    url: string;
    createdTime: Date;
    linkFlairText: string;
    num_comments: number;

    constructor(t: any) {
        this.id = t['id'];
        this.title = t['title'];
        this.author = t['author'];
        this.score = t['score'];
        this.permalink = t['permalink'];
        this.linkFlairText = t['link_flair_text'];
        this.num_comments = t['num_comments'];
        this.createdTime = new Date(t['created'] * 1000);
    }
}
        </code></pre>

        <p>Update logic in <i>common</i> service follows with modified <i>thread</i> model</p>
        <i>src/app/services/common.service.ts</i>
        <pre><code class="typescript">
getThreads(path: String): Observable&#x3C;any&#x3E; {
    return this.httpClient.get(this.appConfig.baseUrl + path + '.json').pipe(
        map(res => {
            return res['data']['children'].map(thread => {
                return new Thread(thread['data']);
            });
        }
        )
    );
}
        </code></pre>

        <p>Run the app to check the result.</p>
        <pre><code class="cmd">
ng serve
        </code></pre>
        <img src="{{ url_for('static', filename='img/posts/2020/angular-reddit-3-check1.png') }}">


        <h3>Top navigation</h3>
        <p>Next step, we will create a navigation bar, which appears on top in every pages.</p>
        <pre><code class="cmd">
ng generate component components/navbar
        </code></pre>


        <i>src/app/components/navbar/navbar.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;navbar&#x22;&#x3E;
    &#x3C;div class=&#x22;navbar-item&#x22;&#x3E;
        &#x3C;a href=&#x22;/&#x22;&#x3E;Frontpage&#x3C;/a&#x3E;
    &#x3C;/div&#x3E;
    &#x3C;div class=&#x22;navbar-item&#x22;&#x3E;
        &#x3C;label&#x3E;
            Subreddit:
            &#x3C;input (keyup.enter)=&#x22;toSubreddit()&#x22; type=&#x22;text&#x22; [formControl]=&#x22;subredditInput&#x22;&#x3E;
        &#x3C;/label&#x3E;
        &#x3C;button (click)=&#x22;toSubreddit()&#x22;&#x3E;Go!&#x3C;/button&#x3E;
    &#x3C;/div&#x3E;
&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}

        <p>We also bind Enter's key up event to <i>toSubreddit</i>, so after inputting subreddit name, we can press Enter without clicking the button.</p>

        <i>src/app/components/navbar/navbar.component.scss</i>
        <pre><code class="css">
.navbar {
    display: flex;
    margin-bottom: 2rem;
    margin-top: 1rem;
}

.navbar .navbar-item {
    margin-right: 1rem;
}
        </code></pre>

        <p>We will move some logic in <i>dashboard</i> to <i>navbar</i>.</p>
        <i>src/app/components/navbar/navbar.component.ts</i>
        <pre><code class="typescript">
...
import { FormControl } from '@angular/forms';
import { Router } from '@angular/router';
import { CommonService } from '../../services/common.service'
...
export class NavbarComponent implements OnInit {

    subredditInput = new FormControl('');

    constructor(private commonService: CommonService, private router: Router) {
    }

    ngOnInit() {
    }

    toSubreddit(): void {
        this.router.navigate(['/r/' + this.subredditInput.value]);
    }
}
        </code></pre>


        <p>Update <i>dashboard</i> and <i>subreddit</i> view.</p>
        <i>src/app/components/dashboard/dashboard.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;app-navbar&#x3E;&#x3C;/app-navbar&#x3E;
&#x3C;app-thread-list [threads]=&#x22;threads&#x22;&#x3E;&#x3C;/app-thread-list&#x3E;
        </code></pre>
        {% endraw %}

        <i>src/app/components/subreddit/subreddit.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;app-navbar&#x3E;&#x3C;/app-navbar&#x3E;
&#x3C;app-thread-list [threads]=&#x22;threads&#x22;&#x3E;&#x3C;/app-thread-list&#x3E;
        </code></pre>
        {% endraw %}

        <p>Run the app to check the result.</p>
        <pre><code class="cmd">
ng serve
        </code></pre>
        <img src="{{ url_for('static', filename='img/posts/2020/angular-reddit-3-check-2.png') }}">


        <h3>Thread browsing</h3>
        <p>So we got front page working, subreddit is also working, next we will implement thread browsing.</p>

        <pre><code class="cmd">
ng generate component components/thread
        </code></pre>

        <p>We add a new <i>reply</i> model and update <i>thread</i> model.</p>
        <i>src/app/models/reply.ts</i>
        <pre><code class="typescript">
export class Reply {
    id: string;
    content: string;
    author: string;
    score: number;
    permalink: string;
    createdTime: Date;
    replies: Reply[];

    constructor(r: any) {
        this.id = r['id'];
        this.author = r['author'];
        this.score = r['score'];
        this.content = r['body']
        this.permalink = r['permalink'];
        this.createdTime = new Date(r['created'] * 1000);

        if (r['replies']) {
            this.replies = r['replies']['data']['children'].map(reply => {
                return new Reply(reply['data']);
            });
        }
    }
}
        </code></pre>

        <p>Each reply can have nested replies inside.</p>

        <i>src/app/models/thread.ts</i>
        <pre><code class="typescript">
import { Reply } from './reply';

export class Thread {
    ...
    content: string;
    replies: Reply[];

    constructor(t: any) {
        ...
        this.content = t['selftext'];
    }
}
        </code></pre>

        <p>Route mapping for thread view.</p>
        <i>src/app/app-routing.module.ts</i>
        <pre><code class="typescript">

import { ThreadComponent } from './components/thread/thread.component'

const routes: Routes = [
    ...
    {
        path: 'r/:subreddit/comments/:id/:permalink', component: ThreadComponent
    }
];
        </code></pre>




        <p>Add the url pattern for reddit thread in config file. We will use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template string</a> to replace placeholders with variable values later.</p>
        <i>src/assets/config.json</i>
        <pre><code class="json">
{
    "baseUrl": "https://old.reddit.com",
    "threadUrlFormat": "/r/${subreddit}/comments/${id}/"
}
        </code></pre>

        <p>Add getter for our new config property.</p>
        <i>src/app/services/app-config.service.ts</i>
        <pre><code class="typescript">
get threadUrlFormat() {
    if (!this.appConfig) {
        throw Error('Config file not loaded!');
    }
    return this.appConfig.threadUrlFormat;
}
        </code></pre>

        <p>In <i>common</i> service, we need a new function to fetch all comments in a thread. The json data structure is simple: the first child is the post content, and second child is list of replies.</p>
        <p>We also used <i>eval</i> to replace placeholders in config string with values.</p>
        <i>src/app/services/common.service.ts</i>
        <pre><code class="typescript">
...
import { Reply } from '../models/reply'
...
getComments(subreddit: string, id: string): Observable&#x3C;Thread&#x3E; {
    return this.httpClient.get(this.appConfigService.baseUrl + eval('`' + this.appConfigService.threadUrlFormat + '`') + '.json').pipe(
        map(res => {
            let t = new Thread(res[0]['data']['children'][0]['data']);
            t.replies = res[1]['data']['children'].map(reply => {
                return new Reply(reply['data']);
            });
            return t;
        }
        )
    );
}
        </code></pre>


        <p>We finished implementation for the service, next is the component.</p>
        <i>src/app/components/thread/thread.component.ts</i>
        <pre><code class="typescript">
...
import { Thread } from '../../models/thread'
import { CommonService } from '../../services/common.service'
import { ActivatedRoute } from '@angular/router';
...
export class ThreadComponent implements OnInit {

    thread: Thread;
    subreddit: string;
    id: string;

    constructor(private commonService: CommonService, private route: ActivatedRoute) {
        this.subreddit = this.route.snapshot.paramMap.get('subreddit');
        this.id = this.route.snapshot.paramMap.get('id');
    }

    ngOnInit() {
        this.loadThread();
    }

    loadThread(): void {
        this.commonService.getComments(this.subreddit, this.id).subscribe(res => {
            this.thread = res;
        })
    }
}
        </code></pre>
        <p>Here we have 3 properties: <i>thread</i> to store data for current viewing thread, <i>subreddit</i> and <i>id</i> are from url. On component init, add a call to <i>loadThread</i>, subscribe to it's observable, and assign it's return value to <i>thread</i> property.</p>


        <h3>Comment view</h3>
        <p>HTML is a bit complicated. Due to Reddit's nesting comment system, we need to implement a simple tree view</p>
        <i>src/app/components/thread/thread.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;thread&#x22; *ngIf=&#x22;thread&#x22;&#x3E;
    &#x3C;div class=&#x22;post&#x22;&#x3E;
        &#x3C;div class=&#x22;title&#x22;&#x3E;
            {{ thread.title }}
        &#x3C;/div&#x3E;
        &#x3C;div class=&#x22;info&#x22;&#x3E;
            {{ thread.createdTime| date:&#x27;fullDate&#x27; }} by &#x3C;span class=&#x22;user&#x22;&#x3E;{{ thread.author }}&#x3C;/span&#x3E;
        &#x3C;/div&#x3E;
        &#x3C;div class=&#x22;content&#x22;&#x3E;
            {{ thread.content }}
        &#x3C;/div&#x3E;
        &#x3C;div class=&#x22;info&#x22;&#x3E;
            &#x3C;span class=&#x22;points&#x22;&#x3E;{{ thread.score }}&#x3C;/span&#x3E; pts - &#x3C;span class=&#x22;comments&#x22;&#x3E;{{ thread.num_comments }}&#x3C;/span&#x3E;
            comments
        &#x3C;/div&#x3E;
    &#x3C;/div&#x3E;
    &#x3C;div class=&#x22;replies&#x22;&#x3E;
        &#x3C;ng-container *ngTemplateOutlet=&#x22;treeViewList; context:{$implicit:thread.replies}&#x22;&#x3E;
        &#x3C;/ng-container&#x3E;
        &#x3C;ng-template #treeViewList let-list&#x3E;
            &#x3C;div class=&#x22;reply&#x22; *ngFor=&#x22;let reply of list;let i=index&#x22;&#x3E;
                &#x3C;span class=&#x22;user&#x22;&#x3E;{{ reply.author }}&#x3C;/span&#x3E;
                &#x3C;div class=&#x22;content&#x22;&#x3E;{{ reply.content }}&#x3C;/div&#x3E;
                &#x3C;div class=&#x22;child&#x22;&#x3E;
                    &#x3C;ng-container *ngTemplateOutlet=&#x22;treeViewList;
                            context:{$implicit: reply.replies}&#x22;&#x3E;
                    &#x3C;/ng-container&#x3E;
                &#x3C;/div&#x3E;
            &#x3C;/div&#x3E;
        &#x3C;/ng-template&#x3E;
    &#x3C;/div&#x3E;
&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}

        <p>Let's dissect the HTML code. The post content is simple, we will focus on the comment part.</p>
        {% raw %}
        <pre><code class="html">
&#x3C;ng-container *ngTemplateOutlet=&#x22;treeViewList; context:{$implicit:thread.replies}&#x22;&#x3E;
&#x3C;/ng-container&#x3E;
        </code></pre>
        {% endraw %}
        <p>Here we tell Angular to render an element using <a href="https://angular.io/api/common/NgTemplateOutlet">ngTemplateOutlet</a>, passing <i>thread.replies</i> as a variable.</p>

        {% raw %}
        <pre><code class="html">
&#x3C;ng-template #treeViewList let-list&#x3E;
    &#x3C;div class=&#x22;reply&#x22; *ngFor=&#x22;let reply of list;let i=index&#x22;&#x3E;
        &#x3C;span class=&#x22;user&#x22;&#x3E;{{ reply.author }}&#x3C;/span&#x3E;
        &#x3C;div class=&#x22;content&#x22;&#x3E;{{ reply.content }}&#x3C;/div&#x3E;
        ...
    &#x3C;/div&#x3E;
&#x3C;/ng-template&#x3E;
        </code></pre>
        {% endraw %}
        <p>Above is template definition, <i>list</i> will have default value from <i>thread.replies</i> since we used $implicit key. Then we have to loop through each reply with <i>ngFor</i>...</p>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;child&#x22;&#x3E;
    &#x3C;ng-container *ngTemplateOutlet=&#x22;treeViewList;
            context:{$implicit: reply.replies}&#x22;&#x3E;
    &#x3C;/ng-container&#x3E;
&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}

        <p>... and render all reply's children by using the same template.</p>

        <p>Then apply some styling.</p>
        <i>src/app/components/thread/thread.component.scss</i>
        <pre><code class="css">
.thread .post {
    margin-bottom: 1rem;
}

.thread .post .title {
    font-size: 2rem;
    color: #353535;
}

.thread .post .info .user {
    color: #3d963b;
}

.thread .post .points {
    color: #E64569;
}

.thread .post .comments {
    color: #439ECF;
}

.thread .replies .reply {
    margin-top: 10px;
}

.thread .replies .reply .content {
    padding-bottom: 10px;
    border-bottom: solid 1px lightgray;
}

.thread .replies .reply .child {
    margin-left: 1rem;
}

.thread .replies .reply .user {
    color: #3d963b;
}
        </code></pre>

        <p>Run the app to check the result.</p>
        <pre><code class="cmd">
ng serve
        </code></pre>
        <img src="{{ url_for('static', filename='img/posts/2020/angular-reddit-3-check-3.png') }}">

        <p>You can see that the comment content is in markdown format, so we are unable to display it correctly. Luckily, reddit json data also has body_html, which is the HTML version of the comment. We will need to update both <i>reply</i> model and thread view.</p>

        <i>src/app/models/reply.ts</i>
        <pre><code class="typescript">
export class Reply {
    ...

    constructor(r: any) {
        ...
        this.content = r['body_html']
        ...
    }
}
        </code></pre>

        <i>src/app/components/thread/thread.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;content&#x22; [innerHTML]=&#x22;reply.content&#x22;&#x3E;&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}
        <p>We use <i>innerHTML</i> property for HTML binding. Now let's check the page again.</p>

        <img src="{{ url_for('static', filename='img/posts/2020/angular-reddit-3-check-4.png') }}">

        <p>Ok so we displayed the HTML, but it's being rendered as a string, we need to parse it into HTML.</p>
        <i>src/app/components/thread/thread.component.ts</i>
        <pre><code class="typescript">
export class ThreadComponent implements OnInit {

    ...
    toHTML(input): any {
        return new DOMParser().parseFromString(input, "text/html").documentElement.textContent;
    }
}
        </code></pre>

        <i>src/app/components/thread/thread.component.html</i>
        {% raw %}
        <pre><code class="html">
&#x3C;div class=&#x22;content&#x22; [innerHTML]=&#x22;toHTML(reply.content)&#x22;&#x3E;&#x3C;/div&#x3E;
        </code></pre>
        {% endraw %}

        <p>Final result.</p>
        <img src="{{ url_for('static', filename='img/posts/2020/angular-reddit-3-check-5.png') }}">



        <p><a href="https://github.com/tranchikhang/a-reddit">Source code on github.</a></p>



{% endblock %}



{% block tail %}
<script src="{{ url_for('static', filename='lib/highlight/highlight.min.js') }}"></script>
<script>hljs.initHighlightingOnLoad();</script>
{% endblock %}
